# 需求文档

## 简介

为 WhatsApp Web 桌面客户端集成全面的聊天翻译功能，支持消息接收翻译、输入框发送翻译、以及多种扩展翻译能力。该系统需要支持多种翻译引擎（Google翻译、AI翻译API），并提供灵活的配置选项以满足不同用户场景的需求。

## 术语表

- **翻译系统**：整个翻译功能模块的统称
- **消息翻译器**：负责翻译接收到的消息的组件
- **输入框翻译器**：负责翻译用户输入内容的组件
- **翻译引擎**：提供实际翻译服务的后端服务（Google、GPT-4、Gemini、DeepSeek等）
- **翻译配置管理器**：管理用户翻译偏好设置的组件
- **语言检测器**：自动识别消息源语言的组件
- **翻译缓存**：存储已翻译内容以提高性能的缓存系统
- **会话上下文**：当前聊天会话的相关信息（联系人、群组等）
- **翻译风格**：AI翻译时应用的语气和表达方式
- **独立翻译配置**：针对特定好友或群组的个性化翻译设置

## 需求

### 需求 1：消息翻译配置管理

**用户故事**：作为用户，我希望能够配置消息翻译的基本设置，以便根据我的需求自动翻译接收到的消息

#### 验收标准

1. WHEN 用户访问翻译设置界面，THE 翻译系统 SHALL 显示自动翻译开关控件
2. WHEN 用户启用自动翻译，THE 翻译系统 SHALL 激活消息翻译功能并保存用户偏好
3. WHEN 用户选择翻译引擎，THE 翻译系统 SHALL 提供谷歌翻译、GPT-4、Gemini、DeepSeek和自定义AI API选项
4. WHEN 用户配置目标语言，THE 翻译系统 SHALL 支持中文简体、英文和其他常用语言的选择
5. WHEN 用户启用群组翻译开关，THE 翻译系统 SHALL 对群组消息应用翻译功能

### 需求 2：消息自动翻译

**用户故事**：作为用户，我希望接收到的消息能够自动翻译成我的目标语言，以便我能理解不同语言的内容

#### 验收标准

1. WHEN 翻译系统接收到新消息且自动翻译已启用，THE 消息翻译器 SHALL 检测消息的源语言
2. WHEN 源语言与目标语言不同，THE 消息翻译器 SHALL 调用配置的翻译引擎进行翻译
3. WHEN 翻译完成，THE 翻译系统 SHALL 在消息下方显示翻译结果
4. WHEN 翻译请求失败，THE 翻译系统 SHALL 显示错误提示并保留原始消息
5. WHILE 群组翻译开关关闭，THE 翻译系统 SHALL 跳过群组消息的翻译处理

### 需求 3：输入框翻译功能

**用户故事**：作为用户，我希望在发送消息前能够将我的输入内容翻译成目标语言，以便与使用不同语言的联系人沟通

#### 验收标准

1. WHEN 用户启用输入框翻译，THE 输入框翻译器 SHALL 在发送按钮旁显示翻译按钮
2. WHEN 用户点击翻译按钮，THE 输入框翻译器 SHALL 翻译输入框中的文本内容
3. WHERE 翻译引擎为AI类型，THE 输入框翻译器 SHALL 应用用户选择的翻译风格
4. WHEN 翻译完成，THE 输入框翻译器 SHALL 将翻译结果替换输入框中的原文本
5. WHEN 用户选择翻译风格，THE 翻译系统 SHALL 提供通用、正式、口语化、亲切、幽默、礼貌、强硬、简洁、激励、中立、专业等选项

### 需求 4：翻译风格处理

**用户故事**：作为用户，我希望AI翻译能够根据不同场景应用合适的语气风格，以便我的消息更符合沟通情境

#### 验收标准

1. WHERE 翻译引擎为AI类型，THE 翻译系统 SHALL 在提示词中包含用户选择的翻译风格
2. WHEN AI翻译引擎处理请求，THE 翻译引擎 SHALL 仅返回翻译后的文本内容，不包含额外说明
3. WHEN 用户切换翻译风格，THE 翻译系统 SHALL 立即应用新风格到后续翻译请求
4. WHERE 翻译引擎为非AI类型，THE 翻译系统 SHALL 隐藏翻译风格选项
5. WHEN 翻译风格未设置，THE 翻译系统 SHALL 使用"通用"作为默认风格

### 需求 5：好友独立翻译配置

**用户故事**：作为用户，我希望能够为不同的联系人设置独立的翻译配置，以便针对不同语言的好友使用不同的翻译设置

#### 验收标准

1. WHEN 用户为特定联系人启用独立翻译，THE 翻译配置管理器 SHALL 创建该联系人的专属翻译配置
2. WHEN 翻译系统处理该联系人的消息，THE 翻译系统 SHALL 优先使用独立翻译配置而非全局配置
3. WHEN 用户修改联系人的独立配置，THE 翻译配置管理器 SHALL 保存更改并立即生效
4. WHEN 用户禁用联系人的独立翻译，THE 翻译系统 SHALL 恢复使用全局翻译配置
5. WHEN 用户查看联系人列表，THE 翻译系统 SHALL 标识已启用独立翻译配置的联系人

### 需求 6：中文输入拦截

**用户故事**：作为用户，我希望能够启用禁发中文功能，以便防止我意外发送中文消息给外语联系人

#### 验收标准

1. WHEN 用户启用禁发中文功能，THE 翻译系统 SHALL 监控输入框的内容变化
2. WHEN 用户尝试发送包含中文字符的消息，THE 翻译系统 SHALL 拦截发送操作
3. WHEN 消息被拦截，THE 翻译系统 SHALL 显示提示信息告知用户需要翻译后发送
4. WHEN 用户禁用禁发中文功能，THE 翻译系统 SHALL 允许发送任何语言的消息
5. WHERE 独立翻译配置已启用，THE 翻译系统 SHALL 支持针对特定联系人配置禁发中文规则

### 需求 7：实时翻译显示

**用户故事**：作为用户，我希望在输入消息时能够实时看到翻译结果，以便我能够即时调整内容

#### 验收标准

1. WHEN 用户启用实时翻译功能，THE 输入框翻译器 SHALL 监听输入框内容变化
2. WHEN 输入内容停止变化超过500毫秒，THE 输入框翻译器 SHALL 自动触发翻译请求
3. WHEN 翻译结果返回，THE 翻译系统 SHALL 在输入框下方显示实时翻译预览
4. WHEN 用户继续输入，THE 翻译系统 SHALL 更新翻译预览内容
5. WHEN 用户禁用实时翻译，THE 翻译系统 SHALL 移除翻译预览显示

### 需求 8：反向翻译验证

**用户故事**：作为用户，我希望能够将翻译后的内容反向翻译回原语言，以便验证翻译的准确性

#### 验收标准

1. WHEN 用户启用反向翻译功能，THE 翻译系统 SHALL 在翻译结果旁显示反向翻译按钮
2. WHEN 用户点击反向翻译按钮，THE 翻译系统 SHALL 将翻译结果翻译回源语言
3. WHEN 反向翻译完成，THE 翻译系统 SHALL 显示反向翻译结果与原文的对比
4. WHEN 反向翻译与原文差异较大，THE 翻译系统 SHALL 显示警告提示
5. WHEN 用户确认翻译准确，THE 翻译系统 SHALL 允许用户继续发送消息

### 需求 9：语音消息翻译

**用户故事**：作为用户，我希望能够翻译接收到的语音消息，以便理解不同语言的语音内容

#### 验收标准

1. WHEN 翻译系统接收到语音消息且语音翻译已启用，THE 翻译系统 SHALL 下载语音文件
2. WHEN 语音文件下载完成，THE 翻译系统 SHALL 调用语音识别服务转换为文本
3. WHEN 语音转文本完成，THE 消息翻译器 SHALL 翻译识别出的文本内容
4. WHEN 翻译完成，THE 翻译系统 SHALL 在语音消息下方显示文本和翻译结果
5. WHEN 语音识别或翻译失败，THE 翻译系统 SHALL 显示错误信息并保留原始语音消息

### 需求 10：图片文字翻译

**用户故事**：作为用户，我希望能够识别并翻译图片中的文字，以便理解图片消息中的文本内容

#### 验收标准

1. WHEN 翻译系统接收到图片消息且图片翻译已启用，THE 翻译系统 SHALL 下载图片文件
2. WHEN 图片下载完成，THE 翻译系统 SHALL 调用OCR服务识别图片中的文字
3. WHEN 文字识别完成，THE 消息翻译器 SHALL 翻译识别出的文本内容
4. WHEN 翻译完成，THE 翻译系统 SHALL 在图片下方显示识别的文本和翻译结果
5. WHEN OCR识别或翻译失败，THE 翻译系统 SHALL 显示错误信息并保留原始图片

### 需求 11：翻译引擎管理

**用户故事**：作为用户，我希望能够配置和管理不同的翻译引擎，以便根据需要选择最合适的翻译服务

#### 验收标准

1. WHEN 用户添加自定义AI翻译引擎，THE 翻译系统 SHALL 要求用户提供API端点、密钥和模型名称
2. WHEN 用户保存翻译引擎配置，THE 翻译系统 SHALL 验证API连接的有效性
3. WHEN API验证失败，THE 翻译系统 SHALL 显示错误信息并阻止保存
4. WHEN 用户切换翻译引擎，THE 翻译系统 SHALL 立即应用新引擎到后续翻译请求
5. WHEN 翻译引擎调用失败，THE 翻译系统 SHALL 记录错误日志并通知用户

### 需求 12：翻译缓存优化

**用户故事**：作为用户，我希望系统能够缓存已翻译的内容，以便提高翻译速度并减少API调用成本

#### 验收标准

1. WHEN 翻译请求完成，THE 翻译缓存 SHALL 存储原文、译文、源语言、目标语言和翻译引擎信息
2. WHEN 翻译系统接收到新的翻译请求，THE 翻译缓存 SHALL 检查是否存在匹配的缓存记录
3. WHEN 缓存命中，THE 翻译系统 SHALL 直接返回缓存的翻译结果而不调用翻译引擎
4. WHEN 缓存记录超过7天，THE 翻译缓存 SHALL 自动清理过期记录
5. WHEN 用户清空翻译缓存，THE 翻译缓存 SHALL 删除所有缓存记录并释放存储空间

### 需求 13：翻译统计与监控

**用户故事**：作为用户，我希望能够查看翻译使用统计，以便了解翻译功能的使用情况和成本

#### 验收标准

1. WHEN 翻译请求完成，THE 翻译系统 SHALL 记录翻译字符数、使用的引擎和响应时间
2. WHEN 用户访问翻译统计页面，THE 翻译系统 SHALL 显示今日、本周、本月的翻译统计数据
3. WHEN 用户查看引擎使用情况，THE 翻译系统 SHALL 显示各翻译引擎的调用次数和成功率
4. WHEN 翻译引擎响应时间超过5秒，THE 翻译系统 SHALL 记录慢查询日志
5. WHEN 翻译失败率超过10%，THE 翻译系统 SHALL 发送告警通知给用户
