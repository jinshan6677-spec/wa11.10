# WhatsApp Desktop - 测试指南

本文档提供详细的测试步骤和验证清单，用于验证 WhatsApp Desktop 应用的所有功能。

## 测试环境要求

- Node.js 18+
- npm 或 yarn
- 有效的 WhatsApp 账号（用于扫码登录）
- 另一台设备用于发送测试消息

## 快速开始

### 1. 验证测试环境

运行测试环境检查脚本：

```bash
npm run test:setup
```

此脚本会检查：
- Node.js 版本
- npm 版本
- 项目依赖
- 源代码文件
- 会话数据
- 资源文件

### 2. 清理会话数据（可选）

如果需要重新测试登录流程，清理已保存的会话数据：

```bash
npm run test:clean
```

**警告：** 此操作会删除所有保存的会话数据，下次启动需要重新扫码。

### 3. 使用测试检查清单

打开 `TEST_CHECKLIST.md` 文件，按照清单逐项测试并记录结果。

---

## 8.1 测试基本功能

### 准备工作

1. 确保已安装所有依赖：
```bash
npm install
```

2. 清理之前的会话数据（如果需要从头测试）：
```bash
npm run test:clean
```

### 测试步骤

#### 步骤 1: 启动应用并验证窗口显示

**操作：**
```bash
npm start
```

**预期结果：**
- ✅ Electron 窗口成功打开
- ✅ 窗口标题显示 "WhatsApp Desktop"
- ✅ 窗口大小为 1200x800 像素
- ✅ 控制台输出启动信息，包括版本号、Node.js 版本、Electron 版本等
- ✅ 控制台显示 "Electron 应用已就绪"
- ✅ 控制台显示 "创建 Electron 窗口..."
- ✅ 控制台显示 "初始化 WhatsApp 客户端..."

**验证清单：**
- [ ] 窗口正常打开
- [ ] 窗口标题正确
- [ ] 窗口大小正确
- [ ] 控制台日志正常输出
- [ ] 没有错误信息

#### 步骤 2: 验证 web.whatsapp.com 正确加载

**操作：**
观察 Electron 窗口内容

**预期结果：**
- ✅ 窗口中加载 WhatsApp Web 页面
- ✅ 显示 WhatsApp 的 logo 和界面
- ✅ 页面加载完成（没有持续的加载动画）
- ✅ 控制台显示 "加载 WhatsApp Web..."

**验证清单：**
- [ ] WhatsApp Web 页面正确加载
- [ ] 页面显示正常（无白屏或错误页面）
- [ ] 页面元素完整显示

#### 步骤 3: 扫描二维码并验证登录

**操作：**
1. 观察窗口中的二维码
2. 使用手机 WhatsApp 扫描二维码：
   - 打开 WhatsApp
   - 点击 "设置" > "已连接的设备"
   - 点击 "连接设备"
   - 扫描电脑屏幕上的二维码

**预期结果：**
- ✅ 窗口中显示二维码
- ✅ 控制台显示 "QR 码已生成，请使用手机扫描登录"
- ✅ 扫描后，控制台显示 "认证成功"
- ✅ 控制台显示 "WhatsApp 客户端已就绪，可以正常使用"
- ✅ 窗口中显示完整的 WhatsApp 聊天界面
- ✅ 可以看到所有聊天记录

**验证清单：**
- [ ] 二维码正确显示
- [ ] 扫码后成功登录
- [ ] 控制台显示认证成功消息
- [ ] 聊天界面正常显示
- [ ] 可以看到联系人列表

#### 步骤 4: 测试消息收发功能

**操作：**
1. 在窗口中选择一个联系人或群组
2. 发送一条测试消息（例如："测试消息 1"）
3. 使用手机向该联系人发送一条消息
4. 观察控制台输出

**预期结果：**
- ✅ 可以在窗口中正常发送消息
- ✅ 发送的消息显示在聊天窗口中
- ✅ 消息显示已发送（单勾或双勾）
- ✅ 收到手机发送的消息
- ✅ 控制台显示 "收到消息: [发送者] - [消息内容]"
- ✅ 消息实时同步

**验证清单：**
- [ ] 可以发送文本消息
- [ ] 发送的消息正确显示
- [ ] 可以接收消息
- [ ] 控制台记录收到的消息
- [ ] 消息同步正常

**测试结果：**
```
测试日期：__________
测试人员：__________
测试结果：[ ] 通过  [ ] 失败
失败原因：__________
```

---

## 8.2 测试会话持久化

### 测试步骤

#### 步骤 1: 重启应用验证无需重新扫码

**前提条件：**
已完成 8.1 的测试，应用已成功登录

**操作：**
1. 关闭应用（点击窗口关闭按钮或 Ctrl+C）
2. 等待 5 秒
3. 重新启动应用：
```bash
npm start
```

**预期结果：**
- ✅ 应用启动时不显示二维码
- ✅ 控制台显示 "认证成功"（使用保存的会话）
- ✅ 控制台显示 "WhatsApp 客户端已就绪，可以正常使用"
- ✅ 窗口直接显示聊天界面（无需扫码）
- ✅ 所有聊天记录正常显示
- ✅ 可以正常收发消息

**验证清单：**
- [ ] 无需重新扫码
- [ ] 自动使用保存的会话登录
- [ ] 聊天界面正常显示
- [ ] 消息功能正常

#### 步骤 2: 验证会话数据正确保存

**操作：**
1. 检查会话数据目录：
```bash
# Windows
dir session-data
dir session-data\.wwebjs_auth

# Linux/macOS
ls -la session-data
ls -la session-data/.wwebjs_auth
```

**预期结果：**
- ✅ `session-data` 目录存在
- ✅ 目录中包含 `.wwebjs_auth` 子目录
- ✅ `.wwebjs_auth` 目录中包含会话文件
- ✅ 文件大小不为 0

**验证清单：**
- [ ] 会话目录存在
- [ ] 会话文件存在
- [ ] 文件内容不为空

#### 步骤 3: 测试会话过期处理

**操作：**
1. 在手机 WhatsApp 中：
   - 打开 "设置" > "已连接的设备"
   - 找到 "WhatsApp Desktop" 连接
   - 点击 "退出登录"
2. 观察桌面应用的反应

**预期结果：**
- ✅ 控制台显示 "客户端已断开连接"
- ✅ 窗口中重新显示二维码
- ✅ 控制台显示 "QR 码已生成，请使用手机扫描登录"
- ✅ 可以重新扫码登录

**验证清单：**
- [ ] 检测到会话过期
- [ ] 重新显示二维码
- [ ] 可以重新登录

**测试结果：**
```
测试日期：__________
测试人员：__________
测试结果：[ ] 通过  [ ] 失败
失败原因：__________
```

---

## 8.3 测试错误场景

### 测试步骤

#### 步骤 1: 测试网络断开和重连

**操作：**
1. 确保应用正常运行且已登录
2. 断开网络连接：
   - Windows: 禁用网络适配器或断开 WiFi
   - Linux/macOS: 关闭 WiFi 或拔掉网线
3. 等待 10 秒
4. 观察控制台输出
5. 重新连接网络
6. 观察应用是否自动重连

**预期结果：**
- ✅ 断网后，控制台显示 "客户端已断开连接"
- ✅ 控制台显示 "尝试重新连接 (1/5)..."
- ✅ 控制台显示 "开始重新连接..."
- ✅ 恢复网络后，应用自动重连
- ✅ 控制台显示 "认证成功"
- ✅ 控制台显示 "WhatsApp 客户端已就绪，可以正常使用"
- ✅ 聊天功能恢复正常

**验证清单：**
- [ ] 检测到网络断开
- [ ] 尝试自动重连
- [ ] 重连成功
- [ ] 功能恢复正常

#### 步骤 2: 测试应用崩溃恢复

**操作：**
1. 启动应用并登录
2. 强制终止应用进程：
   - Windows: 任务管理器 > 结束任务
   - Linux/macOS: `kill -9 <pid>`
3. 重新启动应用

**预期结果：**
- ✅ 应用可以正常重启
- ✅ 会话数据未损坏
- ✅ 无需重新扫码（如果会话未过期）
- ✅ 应用恢复正常工作

**验证清单：**
- [ ] 应用可以重启
- [ ] 会话数据完整
- [ ] 功能正常

#### 步骤 3: 验证错误日志输出

**操作：**
1. 查看控制台输出
2. 检查是否有错误日志
3. 验证日志格式

**预期结果：**
- ✅ 所有日志包含时间戳
- ✅ 日志包含级别标识（INFO、WARN、ERROR）
- ✅ 错误日志包含详细的错误信息
- ✅ 日志格式一致：`[时间戳] [级别] 消息内容`

**示例日志格式：**
```
[2024-01-01T12:00:00.000Z] [INFO] Electron 应用已就绪
[2024-01-01T12:00:01.000Z] [INFO] 创建 Electron 窗口...
[2024-01-01T12:00:02.000Z] [WARN] 客户端已断开连接: NAVIGATION
[2024-01-01T12:00:03.000Z] [ERROR] 认证失败: Session expired
```

**验证清单：**
- [ ] 日志包含时间戳
- [ ] 日志包含级别标识
- [ ] 错误日志详细
- [ ] 日志格式一致

#### 步骤 4: 测试多次重连失败

**操作：**
1. 修改配置文件，减少最大重连次数（用于测试）：
```javascript
// src/config.js
reconnect: {
  enabled: true,
  delay: 2000, // 2秒
  maxAttempts: 2 // 改为 2 次
}
```
2. 启动应用并登录
3. 断开网络
4. 保持网络断开状态，观察重连尝试

**预期结果：**
- ✅ 控制台显示 "尝试重新连接 (1/2)..."
- ✅ 控制台显示 "尝试重新连接 (2/2)..."
- ✅ 控制台显示 "已达到最大重连次数，请手动重启应用"
- ✅ 应用停止尝试重连

**验证清单：**
- [ ] 重连次数正确
- [ ] 达到最大次数后停止
- [ ] 显示提示信息

**测试结果：**
```
测试日期：__________
测试人员：__________
测试结果：[ ] 通过  [ ] 失败
失败原因：__________
```

---

## 测试总结

### 整体测试结果

| 测试项 | 状态 | 备注 |
|--------|------|------|
| 8.1 测试基本功能 | [ ] 通过 [ ] 失败 | |
| 8.2 测试会话持久化 | [ ] 通过 [ ] 失败 | |
| 8.3 测试错误场景 | [ ] 通过 [ ] 失败 | |

### 已知问题

记录测试过程中发现的问题：

1. 
2. 
3. 

### 改进建议

记录测试过程中的改进建议：

1. 
2. 
3. 

---

## 附录：常见问题排查

### 问题 1: 应用启动失败

**症状：** 运行 `npm start` 后应用无法启动

**排查步骤：**
1. 检查 Node.js 版本：`node --version`（需要 18+）
2. 检查依赖是否安装：`npm list`
3. 重新安装依赖：`npm install`
4. 查看错误日志

### 问题 2: 显示"WhatsApp 支持 Google Chrome 60 及更高版本"

**症状：** 窗口显示不支持的浏览器错误

**原因：** Electron 的默认 User-Agent 不被 WhatsApp 识别

**解决方案：**
1. 确保 `src/main.js` 中已设置正确的 User-Agent
2. 检查代码中是否包含 `mainWindow.webContents.setUserAgent()`
3. 重启应用

### 问题 3: 二维码不显示

**症状：** 窗口中没有显示二维码

**排查步骤：**
1. 检查控制台是否有 "QR 码已生成" 消息
2. 检查 Puppeteer 是否正常启动
3. 检查网络连接
4. 清理会话数据后重试：`npm run test:clean`

### 问题 4: 会话无法持久化

**症状：** 每次启动都需要重新扫码

**排查步骤：**
1. 检查 `session-data` 目录是否存在
2. 检查目录权限
3. 检查磁盘空间
4. 查看错误日志

### 问题 5: 消息无法收发

**症状：** 登录成功但无法收发消息

**排查步骤：**
1. 检查网络连接
2. 检查 WhatsApp 服务器状态
3. 重启应用
4. 重新登录

### 问题 6: Puppeteer 启动失败

**症状：** 控制台显示 Chromium 相关错误

**排查步骤：**
1. 检查系统是否安装了必要的依赖
2. Windows: 确保 Visual C++ Redistributable 已安装
3. Linux: 安装 Chromium 依赖：
   ```bash
   sudo apt-get install -y \
     chromium-browser \
     fonts-liberation \
     libasound2 \
     libatk-bridge2.0-0 \
     libatk1.0-0 \
     libcups2 \
     libdbus-1-3 \
     libgbm1 \
     libgtk-3-0 \
     libnspr4 \
     libnss3 \
     libxcomposite1 \
     libxdamage1 \
     libxfixes3 \
     libxrandr2 \
     xdg-utils
   ```

---

## 测试工具和脚本

### 可用的测试脚本

| 脚本 | 命令 | 说明 |
|------|------|------|
| 启动应用 | `npm start` | 正常启动应用 |
| 开发模式 | `npm run dev` | 启动应用并开启调试 |
| 测试环境检查 | `npm run test:setup` | 检查测试环境配置 |
| 清理会话数据 | `npm run test:clean` | 删除保存的会话数据 |

### 测试文档

| 文档 | 说明 |
|------|------|
| TESTING_GUIDE.md | 详细的测试指南（本文档） |
| TEST_CHECKLIST.md | 测试检查清单 |
| README.md | 项目说明文档 |
| USAGE.md | 使用说明文档 |

---

**测试完成日期：** __________

**测试人员签名：** __________
